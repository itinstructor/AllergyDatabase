#:kivy 2.3.1

# Annotated KV file: allergy_database.annotated.kv
# This file is the same UI structure as allergy_database.kv but contains
# inline comments explaining what each block does. Beginners should read
# the comments to learn how KV layouts map to the Python Screen classes.

# Responsive constants: use dp() values and switch sizes for mobile vs desktop.
#:set MOBILE_PADDING dp(15)
#:set DESKTOP_PADDING dp(20)
#:set MOBILE_SPACING dp(15)
#:set DESKTOP_SPACING dp(10)
#:set MOBILE_BUTTON_HEIGHT dp(60)
#:set DESKTOP_BUTTON_HEIGHT dp(40)
#:set MOBILE_INPUT_HEIGHT dp(50)
#:set DESKTOP_INPUT_HEIGHT dp(35)

# -- Reusable widget templates -------------------------------------------------
# These are rules that create small styled widgets for consistent appearance.
# <CommonButton@Button> creates a new widget class named CommonButton that
# behaves like Button but with our chosen defaults (font size and height).
<CommonButton@Button>:
    font_size: sp(14)
    size_hint_y: None
    height: MOBILE_BUTTON_HEIGHT if app.ui_config.is_mobile else DESKTOP_BUTTON_HEIGHT

# CommonLabel sets default font sizing and alignment behavior for labels.
<CommonLabel@Label>:
    font_size: sp(12)
    text_size: self.size
    valign: 'middle'
    halign: 'left'

# CommonTextInput is a TextInput with fixed height so it fits nicely in forms.
<CommonTextInput@TextInput>:
    font_size: sp(12)
    size_hint_y: None
    height: MOBILE_INPUT_HEIGHT if app.ui_config.is_mobile else DESKTOP_INPUT_HEIGHT

# TitleLabel is a larger label used for screen titles.
<TitleLabel@Label>:
    font_size: sp(20)
    bold: True
    size_hint_y: None
    height: dp(80) if app.ui_config.is_mobile else dp(50)

# Styled button subclasses for quick color theming.
<PrimaryButton@CommonButton>:
    background_color: 0.2, 0.6, 1, 1
    color: 1, 1, 1, 1

<SecondaryButton@CommonButton>:
    background_color: 0.7, 0.7, 0.7, 1
    color: 0, 0, 0, 1

<DangerButton@CommonButton>:
    background_color: 1, 0.3, 0.3, 1
    color: 1, 1, 1, 1

<SuccessButton@CommonButton>:
    background_color: 0.3, 0.8, 0.3, 1
    color: 1, 1, 1, 1

# -- Main Screen ---------------------------------------------------------------
# The MainScreen rule defines the UI that appears on the 'main' screen.
# Note: on_kv_post calls a Python method so that the Python Screen instance
# can receive a callback once the KV widgets are bound.
<MainScreen>:
    on_kv_post: root.on_kv_post()
    BoxLayout:
        orientation: 'vertical'
        padding: MOBILE_PADDING * 2 if app.ui_config.is_mobile else DESKTOP_PADDING * 2
        spacing: MOBILE_SPACING * 2 if app.ui_config.is_mobile else DESKTOP_SPACING * 2
        
        # Title at the top
        TitleLabel:
            text: 'Food Allergy Database'
            font_size: sp(28) if app.ui_config.is_mobile else sp(24)
            height: dp(110) if app.ui_config.is_mobile else dp(80)
            halign: 'center'
        
        # Buttons navigate to other screens by calling Python methods on the root.
        PrimaryButton:
            text: 'Add New Allergy'
            height: dp(80) if app.ui_config.is_mobile else dp(60)
            font_size: sp(18) if app.ui_config.is_mobile else sp(16)
            on_press: root.go_to_add()
        
        PrimaryButton:
            text: 'View All Allergies'
            height: dp(80) if app.ui_config.is_mobile else dp(60)
            font_size: sp(18) if app.ui_config.is_mobile else sp(16)
            on_press: root.go_to_list()
        
        PrimaryButton:
            text: 'Search Ingredients'
            height: dp(80) if app.ui_config.is_mobile else dp(60)
            font_size: sp(18) if app.ui_config.is_mobile else sp(16)
            on_press: root.go_to_search()
        
        DangerButton:
            text: 'Exit'
            height: dp(80) if app.ui_config.is_mobile else dp(60)
            font_size: sp(18) if app.ui_config.is_mobile else sp(16)
            on_press: root.exit_app()

# -- Allergy Entry Screen ----------------------------------------------------
# This screen contains a scrollable form for entering a new allergy.
<AllergyEntryScreen>:
    on_kv_post: root.on_kv_post()
    BoxLayout:
        orientation: 'vertical'
        padding: MOBILE_PADDING if app.ui_config.is_mobile else DESKTOP_PADDING
        spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
        
        TitleLabel:
            text: 'Add New Allergy'
            halign: 'center'
        
        # Use a ScrollView so the form works on small screens.
        ScrollView:
            BoxLayout:
                orientation: 'vertical'
                spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
                size_hint_y: None
                height: self.minimum_height
                
                # Main form using a GridLayout. On mobile it is single-column,
                # on wider screens it becomes two columns.
                GridLayout:
                    cols: 1 if app.ui_config.is_mobile else 2
                    spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
                    size_hint_y: None
                    height: self.minimum_height
                    
                    CommonLabel:
                        text: 'Allergen Name:'
                        size_hint_y: None
                        height: dp(40)
                    
                    CommonTextInput:
                        id: allergen_input
                        multiline: False
                    
                    CommonLabel:
                        text: 'Danger Level:'
                        size_hint_y: None
                        height: dp(40)
                    
                    Spinner:
                        id: danger_spinner
                        text: 'Select Level'
                        values: ['1 - Mild', '2 - Moderate', '3 - Severe', '4 - Life-threatening']
                        size_hint_y: None
                        height: MOBILE_INPUT_HEIGHT if app.ui_config.is_mobile else DESKTOP_INPUT_HEIGHT
                        font_size: sp(12)
                
                # Larger multi-line fields for symptoms, ingredients and notes.
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(5)
                    size_hint_y: None
                    height: dp(110)
                    
                    CommonLabel:
                        text: 'Symptoms:'
                        size_hint_y: None
                        height: dp(30)
                        halign: 'left'
                    
                    TextInput:
                        id: symptoms_input
                        multiline: True
                        size_hint_y: None
                        height: dp(80)
                        font_size: sp(12)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(5)
                    size_hint_y: None
                    height: dp(110)
                    
                    CommonLabel:
                        text: 'Common Ingredients:'
                        size_hint_y: None
                        height: dp(30)
                        halign: 'left'
                    
                    TextInput:
                        id: ingredients_input
                        multiline: True
                        size_hint_y: None
                        height: dp(80)
                        font_size: sp(12)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(5)
                    size_hint_y: None
                    height: dp(110)
                    
                    CommonLabel:
                        text: 'Additional Notes:'
                        size_hint_y: None
                        height: dp(30)
                        halign: 'left'
                    
                    TextInput:
                        id: notes_input
                        multiline: True
                        size_hint_y: None
                        height: dp(80)
                        font_size: sp(12)
        
        # Buttons at the bottom: Add, Clear, Back. They rearrange for mobile.
        BoxLayout:
            orientation: 'vertical' if app.ui_config.is_mobile else 'horizontal'
            size_hint_y: None
            height: dp(200) if app.ui_config.is_mobile else dp(60)
            spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
            
            SuccessButton:
                text: 'Add Allergy'
                on_press: root.add_allergy()
            
            SecondaryButton:
                text: 'Clear Form'
                on_press: root.clear_form()
            
            SecondaryButton:
                text: 'Back to Main'
                on_press: root.go_back()

# -- Allergy List Screen -----------------------------------------------------
# Shows all saved allergies in a scrollable area. The Python code builds each
# list item widget programmatically for richer control.
<AllergyListScreen>:
    on_kv_post: root.on_kv_post()
    BoxLayout:
        orientation: 'vertical'
        padding: MOBILE_PADDING if app.ui_config.is_mobile else DESKTOP_PADDING
        spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
        
        # Header area with title and small controls
        BoxLayout:
            orientation: 'vertical' if app.ui_config.is_mobile else 'horizontal'
            size_hint_y: None
            height: dp(140) if app.ui_config.is_mobile else dp(60)
            spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
            
            TitleLabel:
                text: 'Allergy Database'
                size_hint_y: None
                height: dp(80) if app.ui_config.is_mobile else dp(60)
            
            BoxLayout:
                size_hint_y: None
                height: dp(60)
                spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
                size_hint_x: None if not app.ui_config.is_mobile else 1
                width: dp(220) if not app.ui_config.is_mobile else 0
                
                SecondaryButton:
                    text: 'Refresh'
                    size_hint_x: None
                    width: dp(100)
                    on_press: root.refresh_list()
                
                SecondaryButton:
                    text: 'Back'
                    size_hint_x: None
                    width: dp(100)
                    on_press: root.go_back()
        
        # The ScrollView's child has an id so Python can add the list items here.
        ScrollView:
            BoxLayout:
                id: list_layout
                orientation: 'vertical'
                spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
                size_hint_y: None
                height: self.minimum_height

# -- Search Screen -----------------------------------------------------------
# Simple search UI: a text input and a results area below it.
<SearchScreen>:
    on_kv_post: root.on_kv_post()
    BoxLayout:
        orientation: 'vertical'
        padding: MOBILE_PADDING if app.ui_config.is_mobile else DESKTOP_PADDING
        spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
        
        TitleLabel:
            text: 'Search Allergies'
            halign: 'center'
        
        # The top search row contains the input and buttons.
        BoxLayout:
            orientation: 'vertical' if app.ui_config.is_mobile else 'horizontal'
            size_hint_y: None
            height: dp(120) if app.ui_config.is_mobile else dp(50)
            spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
            
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
                
                CommonLabel:
                    text: 'Search:'
                    size_hint_x: None
                    width: dp(80)
                
                CommonTextInput:
                    id: search_input
                    multiline: False
                    hint_text: 'Enter allergen name or ingredient...'
                    on_text: root.on_search_text_change(self, self.text)
            
            BoxLayout:
                size_hint_y: None
                height: dp(60)
                spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
                size_hint_x: None if not app.ui_config.is_mobile else 1
                width: dp(220) if not app.ui_config.is_mobile else 0
                
                PrimaryButton:
                    text: 'Search'
                    size_hint_x: None
                    width: dp(100)
                    on_press: root.search_allergies()
                
                SecondaryButton:
                    text: 'Back'
                    size_hint_x: None
                    width: dp(100)
                    on_press: root.go_back()
        
        # Area that shows the search summary text and the list of results below.
        CommonLabel:
            id: results_label
            text: 'Enter search term above'
            size_hint_y: None
            height: dp(30)
            halign: 'center'
        
        ScrollView:
            BoxLayout:
                id: results_layout
                orientation: 'vertical'
                spacing: MOBILE_SPACING if app.ui_config.is_mobile else DESKTOP_SPACING
                size_hint_y: None
                height: self.minimum_height
